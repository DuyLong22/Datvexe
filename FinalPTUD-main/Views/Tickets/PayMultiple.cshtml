@model List<BusTicketBooking.Models.Ticket>
@{
    ViewData["Title"] = "Thanh toán nhiều vé";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var totalPrice = Model.Sum(t => t.Price);
    var firstTicket = Model.First();
}

<div class="container mt-4">
    <form method="post" asp-action="PayMultipleConfirm" id="paymentForm">
        <!-- Hidden vé -->
        @foreach (var ticket in Model)
        {
            <input type="hidden" name="ticketIds" value="@ticket.TicketId" />
        }
        <input type="hidden" name="paymentMethod" id="paymentMethodHidden" />

        <div class="row">
            <!-- Cột trái: Phương thức thanh toán -->
            <div class="col-md-3">
                <h5 class="mb-3 fw-bold">Chọn phương thức thanh toán</h5>
                <div class="list-group">
                    <label class="list-group-item d-flex align-items-center payment-option">
                        <input type="radio" class="form-check-input" name="method" value="ZaloPay" />
                        <img src="~/images/zalo.webp" alt="ZaloPay" />
                        <span>ZaloPay</span>
                    </label>

                    <label class="list-group-item d-flex align-items-center payment-option">
                        <input type="radio" class="form-check-input" name="method" value="VNPay" />
                        <img src="~/images/logovn.jpg" alt="VNPAY" />
                        <span>VNPAY</span>
                    </label>

                    <label class="list-group-item d-flex align-items-center payment-option">
                        <input type="radio" class="form-check-input" name="method" value="ShopeePay" />
                        <img src="~/images/shopee.webp" alt="ShopeePay" />
                        <span>ShopeePay</span>
                    </label>

                    <label class="list-group-item d-flex align-items-center payment-option">
                        <input type="radio" class="form-check-input" name="method" value="MoMo" />
                        <img src="~/images/logomomo.webp" alt="MoMo" />
                        <span>MoMo</span>
                    </label>

                    <label class="list-group-item d-flex align-items-center payment-option">
                        <input type="radio" class="form-check-input" name="method" value="Vietcombank" checked />
                        <img src="~/images/logovcb.jpg" alt="Vietcombank" />
                        <span>Vietcombank</span>
                    </label>

                    <label class="list-group-item d-flex align-items-center payment-option">
                        <input type="radio" class="form-check-input" name="method" value="Cash" />
                        <img src="~/images/cash.jpg" alt="Cash" />
                        <span>Thanh Toán Tiền Mặt</span>
                    </label>
                </div>
            </div>

            <!-- Cột giữa: QR code + tổng tiền -->
            <div class="col-md-5 text-center">
                <h2 style="font-size: 16px; color: #111">Tổng Thanh Toán</h2>
                <h3 class="text-danger fw-bold" style="font-size: 48px">@totalPrice.ToString("n0") đ</h3>

                <div class="card mb-3 p-3 text-center d-inline-block" id="qrSection" style="display:none;">
                    <img id="qrImage" src="~/images/vietcombank.jpg" alt="QR Code" width="320" class="mx-auto d-block my-3" />
                    <ol class="steps justify-content-center">
                        <li>Dùng biểu tượng <strong>📷</strong> để quét mã QR</li>
                        <li>Quét mã ở trang này và thanh toán</li>
                    </ol>
                    <button type="submit" class="btn btn-success">Tôi đã thanh toán</button>
                </div>
            </div>

            <!-- Cột phải: Thông tin -->
            <div class="col-md-4">
                <div class="card mb-3 p-3 w-100">
                    <h6 class="fw-bold mb-3" style="font-size: 20px;">Thông tin hành khách</h6>
                    <div class="info-row d-flex justify-content-between">
                        <span>Họ và tên:</span>
                        <span class="fw-semibold">@firstTicket.User.Name</span>
                    </div>
                    <div class="info-row d-flex justify-content-between">
                        <span>Số điện thoại:</span>
                        <span class="fw-semibold">@firstTicket.User.Phone</span>
                    </div>
                    <div class="info-row d-flex justify-content-between">
                        <span>Email:</span>
                        <span class="fw-semibold">@firstTicket.User.Email</span>
                    </div>
                </div>

                <div class="card mb-3 p-3 w-100">
                    <h6 class="fw-bold mb-3" style="font-size: 20px;">Thông tin chuyến đi</h6>
                    <div class="info-row d-flex justify-content-between">
                        <span>Tuyến:</span>
                        <span>@firstTicket.Trip.Route.DepartureCity.CityName → @firstTicket.Trip.Route.DestinationCity.CityName</span>
                    </div>
                    <div class="info-row d-flex justify-content-between">
                        <span>Khởi hành:</span>
                        <span>@firstTicket.Trip.DepartureTime.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                </div>

                <div class="card mb-3 p-3 w-100">
                    <h6 class="fw-bold mb-3" style="font-size: 20px;">Danh sách vé</h6>
                    @foreach (var t in Model)
                    {
                        <div class="info-row d-flex justify-content-between">
                            <span>Vé @t.Code (Ghế @t.SeatNumber)</span>
                            <span class="text-danger">@t.Price.ToString("n0") đ</span>
                        </div>
                    }
                    <div class="info-row d-flex justify-content-between fw-bold">
                        <span>Tổng cộng:</span>
                        <span class="text-danger">@totalPrice.ToString("n0") đ</span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    .payment-option {
        padding: 14px 18px;
        font-size: 1.1rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: #f8f9fa;
    }

        .payment-option:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(13, 110, 253, 0.5);
        }

        .payment-option input[type="radio"] {
            transform: scale(1.3);
            margin-right: 12px;
            accent-color: #0d6efd;
        }

        .payment-option img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-right: 12px;
        }

        .payment-option span {
            color: #000;
            font-weight: bold;
            font-size: 16px;
        }

    .info-row {
        padding: 5px 0;
    }

    .steps {
        list-style: none;
        counter-reset: step;
        padding-left: 0;
        margin: 20px auto;
        display: inline-block;
        text-align: left;
    }

        .steps li {
            counter-increment: step;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

            .steps li::before {
                content: counter(step);
                display: flex;
                align-items: center;
                justify-content: center;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                background-color: #6c757d;
                color: #fff;
                font-size: 12px;
                font-weight: bold;
                margin-right: 8px;
            }
</style>

@section Scripts {
    <script>
        const radios = document.querySelectorAll('input[name="method"]');
        const qrImage = document.getElementById("qrImage");
        const qrSection = document.getElementById("qrSection");
        const methodHidden = document.getElementById("paymentMethodHidden");
        const form = document.getElementById("paymentForm");

        const qrMap = {
            "ZaloPay": "/images/zalopay.jpg",
            "ShopeePay": "/images/shopeepay.jpg",
            "MoMo": "/images/momo.jpg",
            "Vietcombank": "/images/vietcombank.jpg"
        };

        radios.forEach(radio => {
            radio.addEventListener("change", function () {
                methodHidden.value = this.value;

                if (this.value === "VNPay") {
                    form.action = "/Payment/VnPay";
                    form.submit();
                } else if (this.value === "Cash") {
                    form.submit();
                } else {
                    qrImage.src = qrMap[this.value];
                    qrSection.style.display = "block";
                }
            });
        });
    </script>
}
